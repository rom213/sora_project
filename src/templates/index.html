{% extends 'layout_message.html' %}

{% block titles %} Chat App {% endblock %}

{% block body %}
<div class="" id="app">

    <div>
        {% include 'header/header.html' %}
    </div>


    <div v-if="navi === 'group'" class="bg-[#A5D2FF] w-full h-screen absolute pt-[70px]">
        <div class="bg-red-100 overflow-x-auto px-1 sm:px-8 h-full relative pb-2 rounded-lg z-40 pt-2">
            {% include 'chatgroup/chatGroup.html' %}
        </div>
    </div>


    <div v-if="navi === 'psi'" class="bg-[#A5D2FF] w-full h-screen pt-[70px] ">
        <div class="bg-red-100 px-1 sm:px-8 h-full pb-2 rounded-lg  pt-2 relative  z-50">
            {% include 'psico/psico.html' %}
        </div>
    </div>

    <div v-if="navi === 'admin'" class="bg-[#A5D2FF] w-full h-screen pt-[70px] ">
        <div class="bg-red-100 px-1 sm:px-8 h-full pb-2 rounded-lg  pt-2 relative z-20 w-full flex justify-center pb-5">
            {% include 'admin/permissions/permissions.html' %}
        </div>
    </div>


</div>


<script>
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
        setup() {
            const socket = ref(null);
            const messages = ref(JSON.parse('{{ messages |tojson | safe }}'));
            const psych = ref(JSON.parse('{{ psychology | tojson | safe }}'));
            const userLogin = ref(JSON.parse('{{ userLogin |tojson | safe }}'));
            const countMessages = ref({
                'group': 0,
                'psi': 0
            })

            const sidebarPsych = ref(false)

            const psychologyMessage = ref(null)
            const message = ref('');
            const navi = ref('psi');


            const modalEmojis = ref(false);



            let emojis = ref([
                'üòÄ', 'üòÑ', 'üòÅ', 'üòÇ', 'ü§£', 'üòä', 'üòç', 'ü•∞', 'ü§≠', 'ü§∑',
                'üôã‚Äç‚ôÄÔ∏è', 'üôã', 'üôà', 'üôâ', 'üôä', 'ü´¶', 'üêØ', 'üåø', '‚òò', 'üçÄ',
                '‚ö°', 'üî•', 'üí•', '‚õà', 'üåû', 'üéÑ', 'üíè', 'üò°', 'üòî', 'üçâ',
                'üçä', 'üèâ', 'üèä‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è', 'üéØ', 'ü™ë', 'üë©‚Äçü¶Ø', 'üéâ', 'üéÇ', 'üéÉ',
                'üïØ', 'üéÅ', 'üéà', 'üç™', 'üç©', 'üçª', 'ü•Ç', 'ü•≥', 'ü§ñ', 'üëæ',
                'ü§°', 'üëª', 'üëΩ', 'üíÄ', 'üéÉ', 'üé®', 'üé§', 'üéß', 'üé∑', 'üé∏',
                'üé∫', 'üéª', 'ü•Å', 'üéÆ', 'üñ•', 'üíª', 'üì±', 'üì∑', 'üì∫', '‚è∞',
                'üõè', 'üö™', 'üóù', 'üõã', 'üöΩ', 'üöø', 'üõÅ', 'üõí', 'üö≤', 'üöï',
                'üöå', 'üöé', 'üöì', 'üöë', 'üöí', 'üöú', 'üöõ', 'üöç', 'üöÇ', 'üöÄ',
                'üé¢', 'üé°', 'üé†', 'üé™', 'üé¨', 'üé≠', 'üñº', 'üé≥', 'üéΩ', 'üèÖ',
                'üèÜ', 'ü•á', 'ü•à', 'ü•â', '‚öΩ', 'üèÄ', 'üèà', 'üéæ', 'üèê', 'üèì',
                'üè∏', 'üèí', 'üèë', 'ü•Ö', '‚õ≥', 'üé£', 'ü§ø', 'üéΩ', 'üèπ', 'üßë‚Äçüé§',
                'üßë‚Äçüç≥', 'üßë‚Äçüî¨', 'üßë‚ÄçüöÄ', 'üë∂', 'üë®‚Äçüçº', 'üßì', 'ü¶∏‚Äç‚ôÇÔ∏è', 'ü¶∏‚Äç‚ôÄÔ∏è', 'ü¶π‚Äç‚ôÇÔ∏è', 'ü¶π‚Äç‚ôÄÔ∏è',
                'üßô‚Äç‚ôÇÔ∏è', 'üßô‚Äç‚ôÄÔ∏è', 'üßö‚Äç‚ôÇÔ∏è', 'üßö‚Äç‚ôÄÔ∏è', 'üßû‚Äç‚ôÇÔ∏è', 'üßû‚Äç‚ôÄÔ∏è', 'üßú‚Äç‚ôÇÔ∏è', 'üßú‚Äç‚ôÄÔ∏è', 'üßõ‚Äç‚ôÇÔ∏è', 'üßõ‚Äç‚ôÄÔ∏è',
                'üßü‚Äç‚ôÇÔ∏è', 'üßü‚Äç‚ôÄÔ∏è', 'üñï', 'ü•µ', 'ü§§', 'üòà'
            ]);



            let indexMessagePys = null
            let actionBeggin = true

            function updateMessageCountPsi() {
                if (psych.value) {
                    psych.value.forEach(conexion => {
                        if (actionBeggin) {
                            countMessages.value.psi = countMessages.value.psi + conexion.countMessage
                        }
                        else {
                            if (conexion.countMessage !== 0) {
                                countMessages.value.psi = countMessages.value.psi + 1
                                reproducirAudio()
                            }
                        }
                        actionBeggin = false
                    }
                    )
                }

            }

            watch(psych, updateMessageCountPsi, { immediate: true });
            watch(userLogin, () => {
                if (userLogin.value.rol === 'admin') {
                    navi.value = 'admin'
                }
            }, { immediate: true });








            toogleSidebarPsi = () => {
                sidebarPsych.value = !sidebarPsych.value
            }


            toogleNaviChatPsyc = (index, id) => {
                sidebarPsych.value = false
                indexMessagePys = id
                psychologyMessage.value = psych.value[index];

                if (psychologyMessage.value.countMessage !== 0) {

                    data = { message: message.value, conexion_id: psychologyMessage.value.conexion_id, user_id: psychologyMessage.value.id, rol: psychologyMessage.value.rol }
                    socket.value.emit('read_message', data)
                    countMessages.value.psi = countMessages.value.psi - psychologyMessage.value.countMessage
                    psychologyMessage.value.countMessage = 0
                    message.value = '';

                }
                message.value = '';
            }


            const toogleEmojis = () => {
                modalEmojis.value = !modalEmojis.value
            }

            const toogleNvigate = (val) => {
                if (val == 'group') {
                    countMessages.value.group = 0
                    psychologyMessage.value = null
                }
                navi.value = val
            }



            const adEmoji = (value) => {
                message.value = message.value.concat(value)
            }



            const sendMessage = (user) => {
                if (message.value && navi.value === 'group') {
                    socket.value.emit('message', message.value);
                    message.value = '';
                }

                if (message.value && navi.value === 'psi') {

                    data = { message: message.value, conexion_id: user.conexion_id, user_id: user.id, rol: user.rol }
                    socket.value.emit('message_psi', data)
                    message.value = '';
                }
            };

            function reproducirAudio() {
                const audio = document.getElementById('miAudio');

                audio.play().catch(error => {
                    console.error("Error al reproducir el audio:", error);
                });
            }

            onMounted(() => {
                socket.value = io.connect();


                socket.value.on('message', (data) => {
                    if (navi.value !== 'group') {
                        countMessages.value.group = countMessages.value.group + 1
                        reproducirAudio()
                    }


                    messages.value.push(data[data.length - 1]);
                });




                socket.value.on('message_psi', (data) => {
                    if (data[0].userLoginId === userLogin.value.id) {
                        if (indexMessagePys !== null) {
                            psychologyMessage.value = data.find(item => item.id === indexMessagePys);

                            psychologyMessage.value.countMessage = 0

                            data_env = { message: message.value, conexion_id: psychologyMessage.value.conexion_id, user_id: psychologyMessage.value.id, rol: psychologyMessage.value.rol }

                            socket.value.emit('read_message', data_env)
                        }


                        psych.value = data
                    }



                });
            });



            //////////////////functions admin user////////////////////////////

            const idUserAdminForm = ref(null)
            const userData = ref(null);

            watch(idUserAdminForm, async (newValue) => {
                if (newValue !== null) { // Verifica si el ID es v√°lido
                    try {
                        const response = await axios.get(`https://jsonplaceholder.typicode.com/users/${newValue}`);
                        userData.value = response.data;
                    } catch (error) {
                        console.error('Error al obtener los datos del usuario:', error);
                    }
                } else {
                    userData.value = null; // Reinicia userData si el ID es inv√°lido
                }
            }, { immediate: true });




            return {
                userLogin,

                messages,
                message,
                sendMessage,



                emojis,
                toogleEmojis,
                modalEmojis,
                adEmoji,


                navi,
                toogleNvigate,

                psych,

                psychologyMessage,
                toogleNaviChatPsyc,

                countMessages,

                sidebarPsych,
                toogleSidebarPsi,

                idUserAdminForm

            };
        }
    }).mount('#app');
</script>




<style>
    .scrollbar-custom::-webkit-scrollbar {
        width: 8px;
        /* Ancho del scrollbar */
        height: 8px;
        /* Altura del scrollbar (para el desplazamiento horizontal) */
    }

    .scrollbar-custom::-webkit-scrollbar-thumb {
        background-color: #888;
        /* Color del "pulgar" */
        border-radius: 10px;
        /* Bordes redondeados */
    }

    .scrollbar-custom::-webkit-scrollbar-thumb:hover {
        background-color: #555;
        /* Color del "pulgar" al pasar el rat√≥n por encima */
    }
</style>
{% endblock %}