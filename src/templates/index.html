{% extends 'layout_message.html' %}

{% block titles %} Chat App {% endblock %}

{% block body %}
<div class="" id="app">

    <div>
        {% include 'header/header.html' %}
    </div>

    <div v-if="modalUser"
        class=" bg-white rounded-md shadow-sm absolute w-64  z-50 right-0 top-16 p-4 flex flex-col gap-3">
        <div class="flex gap-5">
            <div class="flex items-center justify-center rounded-full w-12 h-12 relative cursor-pointer">
                {% if current_user.avatar %}
                <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}" alt="avatar"
                    class="w-full h-full object-cover rounded-full" />
                {% else %}
                <span class="font-extrabold text-xl">
                    {{ current_user.init_letters() }}
                </span>
                {% endif %}
                <div class="absolute m -bottom-1 -left-1">
                    <svg width="23" height="24" viewBox="0 0 23 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                        xmlns:xlink="http://www.w3.org/1999/xlink">
                        <rect width="23" height="24" fill="url(#pattern0_127_82)" />
                        <defs>
                            <pattern id="pattern0_127_82" patternContentUnits="objectBoundingBox" width="1" height="1">
                                <use xlink:href="#image0_127_82" transform="matrix(0.01 0 0 0.00958333 0 0.0208333)" />
                            </pattern>
                            <image id="image0_127_82" width="100" height="100"
                                xlink:href="data:image/png;base64,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" />
                        </defs>
                    </svg>

                </div>
            </div>
            <div>
                <div class="text-xl" v-html="userLogin.name+' ' + userLogin.lastname"></div>
                <div class="flex text-sm"><span>ID:</span>
                    <div v-html="userLogin.iuud"></div>
                </div>
            </div>
        </div>

        <div>
            <div class="text-xs">
                username
            </div>
            <div v-html="userLogin.username">
            </div>
        </div>
        <div>
            <div class="text-xs">
                anonymous user
            </div>
            <div v-html="userLogin.anonymous_user">
            </div>
        </div>
        <div class="flex justify-between">
            <div>
                <div class="text-xs">
                    ROL
                </div>
                <div>
                    <div v-if="userLogin.rol==='user'">
                        User
                    </div>
                    <div v-if="userLogin.rol==='admin'">
                        Admin
                    </div>
                    <div v-if="userLogin.rol==='psi'">
                        Psychologist
                    </div>
                </div>
            </div>
            <div class="cursor-pointer flex" @click="toogleModalEditUser">
                <svg class="hover:scale-125 " width="50" height="50" viewBox="0 0 50 50" fill="none"
                    xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <rect width="50" height="50" fill="url(#pattern0_186_7)" />
                    <defs>
                        <pattern id="pattern0_186_7" patternContentUnits="objectBoundingBox" width="1" height="1">
                            <use xlink:href="#image0_186_7" transform="scale(0.01)" />
                        </pattern>
                        <image id="image0_186_7" width="100" height="100"
                            xlink:href="data:image/png;base64,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" />
                    </defs>
                </svg>
                <div id="logoutBtn" class="flex items-center justify-end">
                    <a href="{{ url_for('users.logout') }}"
                        class="flex items-center px-2 py-0.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-300">
                        <i class="fas fa-sign-out-alt mr-1"></i></a>
                </div>
            </div>
        </div>
    </div>

    <div v-if="modalEditUser" class="absolute bg-[#2626265f] z-50 flex justify-center items-center w-full h-full ">
        <form action="{{ url_for('users.update') }}" method="post" enctype="multipart/form-data"
            class="relative shadow-sm overflow-hidden rounded-[3%] p-3 bg-white w-full max-w-lg mx-auto h-auto sm:h-[400px]">
            <div class="flex justify-center items-center mb-5 mt-2">
                <h1 class="text-[#4d94ff] text-2xl sm:text-3xl font-serif text-center">Update your Account</h1>
            </div>
            <div class="grid gap-4 sm:gap-2">

                <div class="flex flex-col group">
                    <label for="email"
                        class="text-[#000000a6] pl-4 sm:pl-10 font-normal hidden group-focus-within:block">Name:</label>
                    <input placeholder="Your Name"
                        class="outline-none bg-[#eaf5ff] text-clip rounded-lg h-10 sm:h-12 pl-4" type="text" id="name"
                        name="name" v-model="userLogin.name" required>
                </div>
                <div class="flex flex-col group">
                    <label for="lastname"
                        class="text-[#000000a6] pl-4 sm:pl-10 font-normal hidden group-focus-within:block">Last
                        Name:</label>
                    <input placeholder="Your Last Name" v-model="userLogin.lastname"
                        class="outline-none bg-[#eaf5ff] text-clip rounded-lg h-10 sm:h-12 pl-4" type="text"
                        id="lastname" name="lastname" required>
                </div>

                <div class="flex flex-col group">
                    <label for="avatar"
                        class="text-[#000000a6] pl-4 sm:pl-10 font-normal hidden group-focus-within:block">Profile
                        Picture</label>
                    <div class="bg-[#eaf5ff] rounded-lg h-10 sm:h-12 pl-3 flex justify-start items-center">
                        <input type="file" name="avatar" id="avatar" accept="image/*" class="text-sm sm:text-base" />
                    </div>
                </div>

                <div class="flex flex-col group">
                    <label for="anonymous_user"
                        class="text-[#000000a6] pl-4 sm:pl-10 font-normal hidden group-focus-within:block">Anonymous
                        User</label>
                    <input placeholder="Your Anonymous User"
                        class="outline-none bg-[#eaf5ff] text-clip rounded-lg h-10 sm:h-12 pl-4" type="text"
                        id="anonymous_user" name="anonymous_user" v-model="userLogin.anonymous_user" required>
                </div>

                <div class="flex justify-evenly items-center mt-4">
                    <div @click="toogleModalEditUser"
                        class="px-3 py-2 text-[#000] h-10 sm:h-12 ml-2 flex items-center justify-center hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="h-6 w-6">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M6.75 15.75 3 12m0 0 3.75-3.75M3 12h18" />
                        </svg>
                    </div>
                    <button type="submit"
                        class="bg-[#50a4f8] px-4 sm:px-6 py-2 rounded-lg hover:bg-[#aadbfc] active:scale-95 duration-200 text-white h-10 sm:h-12">
                        Update Account
                    </button>
                </div>
            </div>
        </form>

    </div>


    <div v-if="messageEdit" class="absolute bg-[#2626265f] z-50 flex justify-center items-center w-full h-full ">
        <div class="">
            <form @submit.prevent="saveMessage('update')" method="post" enctype="multipart/form-data"
                class="relative shadow-sm overflow-hidden rounded-[3%] p-3 bg-white w-full md:w-[350px] max-w-lg mx-auto h-auto">
                <div class="flex justify-center items-center mb-5 mt-2">
                    <h1 class="text-[#4d94ff] text-2xl sm:text-3xl font-serif text-center">Update message</h1>
                </div>
                <div class="grid gap-4 sm:gap-2">

                    <div class="flex flex-col group">
                        <label for="email"
                            class="text-[#000000a6] font-normal hidden group-focus-within:block">message:</label>
                        <input placeholder="message"
                            class="outline-none bg-[#eaf5ff] text-clip rounded-lg h-10 sm:h-12 pl-4" type="text"
                            id="name" name="name" v-model="messageEdit.message" required>
                    </div>



                    <div class="flex justify-between items-center mt-4">
                        <div @click="toogleModalEditMessage(false)"
                            class="px-3 py-2 text-[#000] h-10 sm:h-12 ml-2 flex items-center justify-center hover:scale-110">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="h-6 w-6">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M6.75 15.75 3 12m0 0 3.75-3.75M3 12h18" />
                            </svg>

                        </div>

                        <div class="flex gap-2">

                            <div @click="saveMessage('delete')"
                                class="hover:bg-red-300 cursor-pointer p-2 rounded-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </div>
                            <button type="submit"
                                class="bg-[#50a4f8] px-4 sm:px-6 py-2 rounded-lg hover:bg-[#aadbfc] active:scale-95 duration-200 text-white h-10 sm:h-12">
                                Update
                            </button>
                        </div>

                    </div>
                </div>
            </form>

        </div>
    </div>






    <div v-if="navi === 'group'" class="bg-[#A5D2FF] w-full h-screen absolute pt-[70px]">
        <div class="bg-white overflow-x-auto px-1 sm:px-8 h-full relative pb-2 rounded-lg z-40 pt-2">
            {% include 'chatgroup/chatGroup.html' %}
        </div>
    </div>


    <div v-if="navi === 'psi'" class="bg-[#A5D2FF] w-full h-screen pt-[70px] ">
        <div class="bg-red-100 px-1 sm:px-8 h-full pb-2 rounded-lg  pt-2 relative  z-10">
            {% include 'psico/psico.html' %}
        </div>
    </div>

    <div v-if="navi === 'admin'" class="bg-[#A5D2FF] w-full h-screen pt-[70px] ">
        <div class="bg-red-100 px-1 sm:px-8 h-full rounded-lg  pt-2 relative z-20 w-full flex justify-center pb-5">
            {% include 'admin/permissions/permissions.html' %}
        </div>
    </div>


    <div v-if="navi === 'toato'" class="bg-[#A5D2FF] w-full h-screen pt-[70px] ">
        <div class="bg-red-100 px-1 sm:px-8 h-full rounded-lg  pt-2 relative z-20 w-full flex justify-center pb-5">
            {% include 'toato/toato.html' %}
        </div>
    </div>




</div>


<script>
    const { createApp, ref, onMounted, watch } = Vue;

    createApp({
        setup() {
            const socket = ref(null);
            const messages = ref(JSON.parse('{{ messages |tojson | safe }}'));
            const psych = ref(JSON.parse('{{ psychology | tojson | safe }}'));
            const toato = ref(JSON.parse('{{ toato | tojson | safe }}'));



            const userLogin = ref(JSON.parse('{{ userLogin |tojson | safe }}'));
            const countMessages = ref({
                'group': 0,
                'psi': 0,
                'toato': 0
            })

            const userToato = ref(null);

            const sidebarPsych = ref(false)
            const sidebarToaTo = ref(false)

            const psychologyMessage = ref(null)
            const psychologyMessageToaTo = ref(null)
            const message = ref('');
            const navi = ref('toato');


            const modalEmojis = ref(false);



            let emojis = ref([
                '😀', '😄', '😁', '😂', '🤣', '😊', '😍', '🥰',
                '😔', '😡', '😈', '🥵', '🤤', '🤩', '😢', '😜',
                '😅', '😆', '😇', '🙃', '😏', '😞', '😕', '😟',
                '😤', '😩', '😭', '😱', '😳', '😜', '🤯', '😎',
                '🤭', '🤷', '🙋‍♀️', '🙋', '🙈', '🙉', '🙊', '🖕',
                '👍', '👎', '👏', '👌', '✌️', '🤙', '🙏', '🤟',
                '💏', '💖', '💘', '💝', '💔', '💕', '💞', '💓',
                '💗', '💙', '💚', '💛', '🖤', '💜', '🤍', '💟',
                '⚡', '🔥', '💥', '🌞', '🌿', '☘', '🍀', '🌻',
                '🌈', '❄️', '💨', '🌊', '🌧', '🌪', '⛈', '🌋',
                '💻', '📱', '🖥', '📷', '📺', '⌚', '⏰', '💡',
                '🔋', '🔌', '📞', '🔑', '🛏', '🚪', '🚿', '🛁',
                '⚽', '🏀', '🏈', '🎾', '🏆', '🥇', '🥈', '🥉',
                '🎮', '🎳', '🏓', '🏸', '🏒', '🎯', '🤿', '🏹',
                '🍉', '🍊', '🍪', '🍩', '🍻', '🥂', '🍔', '🍕',
                '🍖', '🍗', '🍤', '🍣', '🍚', '🍜', '🍫', '🍿',
                '👾', '👻', '🤖', '💀', '🎃', '🧛‍♂️', '🧟‍♂️', '🧞‍♂️',
                '🧙‍♂️', '🦸‍♀️', '🦹‍♂️', '🧜‍♀️', '🧚‍♀️', '👽', '🤡', '🎩',
                '🚕', '🚀', '🚌', '🚎', '🚓', '🚑', '🚒', '🚜',
                '🚂', '🚃', '🚁', '🛳', '🚢', '🚤', '⛵', '🚲',
                '🎤', '🎸', '🎺', '🎻', '🥁', '🎷', '🎧', '🎼',
            ]);



            let indexMessagePys = null
            let indexMessageToato = null

            let actionBeggin = true
            let actionBegginToato = true

            function updateMessageCountPsi() {
                const count = countMessages.value.psi
                countMessages.value.psi = 0
                if (psych.value) {
                    psych.value.forEach(conexion => {
                        countMessages.value.psi = countMessages.value.psi + conexion.countMessage
                    }
                    )

                    if (countMessages.value.psi > count) {
                        reproducirAudio()
                    }

                }

            }

            watch(psych, updateMessageCountPsi, { immediate: true });



            function updateMessageCountToato() {
                if (toato.value) {
                    const count = countMessages.value.toato
                    countMessages.value.toato = 0
                    toato.value.forEach(conexion => {
                        countMessages.value.toato = countMessages.value.toato + conexion.countMessage
                    }
                    )

                    if (countMessages.value.toato > count) {
                        reproducirAudio()
                    }


                }

            }

            watch(toato, updateMessageCountToato, { immediate: true });


            watch(userLogin, () => {
                if (userLogin.value.rol === 'admin') {
                    navi.value = 'admin'
                }
            }, { immediate: true });








            toogleSidebarPsi = () => {
                sidebarPsych.value = !sidebarPsych.value
            }

            toogleSidebarToato = () => {
                sidebarToaTo.value = !sidebarToaTo.value
            }


            toogleNaviChatPsyc = (index, id) => {
                sidebarPsych.value = false
                indexMessagePys = id
                psychologyMessage.value = psych.value[index];

                if (psychologyMessage.value.countMessage !== 0) {

                    data = { message: message.value, conexion_id: psychologyMessage.value.conexion_id, user_id: psychologyMessage.value.id, rol: psychologyMessage.value.rol }
                    socket.value.emit('read_message', data)
                    countMessages.value.psi = countMessages.value.psi - psychologyMessage.value.countMessage
                    psychologyMessage.value.countMessage = 0
                    message.value = '';

                }
                message.value = '';
            }

            const toogleNaviChatToatoFind = () => {
                data = toato.value.find(item => item.id === userToato.value.id);

                idUserAdminForm.value = null

                if (data) {
                    psychologyMessageToaTo.value = data
                    indexMessageToato = userToato.value.id
                }
                else {
                    psychologyMessageToaTo.value = userToato.value
                    indexMessageToato = userToato.value.id
                }
                userToato.value = null




                psychologyMessageToaTo.value.countMessage = 0
            }

            const toogleNaviChatToato = (index, id) => {
                sidebarToaTo.value = false
                indexMessageToato = id
                psychologyMessageToaTo.value = toato.value[index];

                if (psychologyMessageToaTo.value.countMessage !== 0) {

                    data = { message: message.value, conexion_id: psychologyMessageToaTo.value.conexion_id, user_id: psychologyMessageToaTo.value.id, rol: psychologyMessageToaTo.value.rol }
                    socket.value.emit('read_message', data)
                    countMessages.value.toato = countMessages.value.toato - psychologyMessageToaTo.value.countMessage
                    psychologyMessageToaTo.value.countMessage = 0
                    message.value = '';

                }
                message.value = '';
            }


            const toogleEmojis = () => {
                modalEmojis.value = !modalEmojis.value
            }

            const toogleNvigate = (val) => {
                if (val == 'group') {
                    countMessages.value.group = 0
                    psychologyMessage.value = null
                    psychologyMessageToaTo.value = null
                    indexMessageToato = null

                    indexMessagePys = null
                }


                navi.value = val
            }



            const adEmoji = (value) => {
                message.value = message.value.concat(value)
            }


            const deleteConexion = (user) => {
                data = { message: message.value, conexion_id: user.conexion_id, user_id: user.id, rol: user.rol, conexion_type: user.conexion_type }
                socket.value.emit('conexion_delete', data);
                if (navi.value === 'psi') {
                    psychologyMessage.value = null
                    psych.value.filter((message) => message.id != user.id)
                }

                if (navi.value === 'toato') {
                    psychologyMessageToaTo.value = null
                    console.log(user.id);
                    const filter = toato.value.filter((message) => message.id !== user.id)
                    toato.value = filter
                }
            }


            const sendMessage = (user) => {
                if (message.value && navi.value === 'group') {
                    socket.value.emit('message', message.value);
                    message.value = '';
                }

                if (message.value && (navi.value === 'psi' || navi.value === 'toato')) {
                    data = {}
                    if (navi.value === 'psi') {
                        data = { message: message.value, conexion_id: user.conexion_id, user_id: user.id, rol: user.rol, conexion_type: 'psi' }
                        socket.value.emit('message_psi', data)
                    }
                    if (navi.value === 'toato') {
                        data = { message: message.value, conexion_id: user.conexion_id, user_id: user.id, rol: user.rol, conexion_type: 'toato' }
                        socket.value.emit('message_toato', data)
                    }
                    message.value = '';
                }
            };
            function reproducirAudio() {
                const audio = document.getElementById('miAudio');
                console.log(audio);
                if (audio) {
                    audio.play()
                } else {
                    console.error("No se encontró el elemento de audio en el HTML.");
                }
            }


            onMounted(() => {
                socket.value = io.connect();


                socket.value.on('message', (data) => {
                    if (navi.value !== 'group') {
                        countMessages.value.group = countMessages.value.group + 1
                        reproducirAudio()
                    }
                    messages.value = data;
                });


                socket.value.on('user_data', (data) => {
                    if (userLogin.value.id === data.id) {
                        window.location.reload()
                    }
                });




                socket.value.on('message_psi', (data) => {

                    if (data[0].userLoginId === userLogin.value.id) {
                        if (indexMessagePys !== null) {
                            psychologyMessage.value = data.find(item => item.id === indexMessagePys);

                            psychologyMessage.value.countMessage = 0

                            data_env = { message: message.value, conexion_id: psychologyMessage.value.conexion_id, user_id: psychologyMessage.value.id, rol: psychologyMessage.value.rol }

                            socket.value.emit('read_message', data_env)
                        }


                        psych.value = data
                    }
                });


                socket.value.on('message_toato', (data) => {
                    if (data[0].data) {
                        if (data[0].userLoginId === userLogin.value.id) {
                            if (indexMessageToato !== null) {
                                psychologyMessageToaTo.value = data.find(item => item.id === indexMessageToato);

                                psychologyMessageToaTo.value.countMessage = 0

                                data_env = { message: message.value, conexion_id: psychologyMessageToaTo.value.conexion_id, user_id: psychologyMessageToaTo.value.id, rol: psychologyMessageToaTo.value.rol }

                                socket.value.emit('read_message', data_env)
                            }
                            toato.value = data
                        }
                    }
                    if (!data[0].data && data[0].userLoginId === userLogin.value.id) {
                        toato.value = []
                        psychologyMessageToaTo.value = null
                    }


                });
            });



            //////////////////functions admin user////////////////////////////

            const idUserAdminForm = ref(null)
            const userDataSearch = ref(null);
            const selectedRole = ref('');
            const allUserAdminPsi = ref([])
            const actionWatchUsersAdmin = ref(0)

            watch(idUserAdminForm, async (newValue) => {
                if (newValue !== null) {
                    if (newValue.length === 15) { // Verifica si el ID es válido
                        try {
                            const response = await axios.get(`/users/${newValue}`);
                            if (navi.value === 'admin') {
                                userDataSearch.value = response.data;
                                selectedRole.value = response.data.rol
                            }



                            if (navi.value === 'toato') {
                                userToato.value = response.data

                            }
                        } catch (error) {
                            console.error('Error al obtener los datos del usuario:', error);
                        }
                    } else {
                        if (navi.value === 'admin') {
                            userDataSearch.value = null
                        }

                        if (navi.value === 'toato') {
                            userToato.value = null
                        }
                    }

                    if (newValue.length === 0) {
                        idUserAdminForm.value = null
                    }
                }

            }, { immediate: true });


            const submitSaveRolUser = async (user_id) => {
                if (userDataSearch) {
                    try {
                        const response = await axios.post('/users/admin', {
                            rol: selectedRole.value,
                            user_id: user_id
                        });

                        if (response.status == 201) {
                            actionWatchUsersAdmin.value = actionWatchUsersAdmin.value + 1
                            idUserAdminForm.value = null
                        }
                    } catch (error) {
                        console.error('Error al crear el usuario:', error);
                    }
                }
            }

            const submitUserSelect = (user) => {
                idUserAdminForm.value = user.iuud


            }

            const getUsersAdmin = async () => {
                try {
                    const response = await axios.get(`/users/admin`);
                    allUserAdminPsi.value = response.data
                } catch (error) {
                    allUserAdminPsi.value = []
                }
            }

            watch(actionWatchUsersAdmin, async () => {
                await getUsersAdmin()
            }, { immediate: true });




            ////////////////////actiosn////////////////////////////////////////////



            const modalUser = ref(false)
            const modalEditUser = ref(false)

            const messageEdit = ref(null)

            const toogleModalUser = () => {
                modalUser.value = !modalUser.value
            }

            const toogleModalEditUser = () => {
                modalEditUser.value = !modalEditUser.value
            }

            let tem_message = ''

            const toogleModalEditMessage = (msg, message) => {
                if (msg) {
                    messageEdit.value = msg
                    tem_message = message
                } else {
                    messageEdit.value.message = tem_message
                    messageEdit.value = null
                }
            }

            const saveMessage = (action_type) => {
                if (navi.value === 'group') {
                    data = { message: messageEdit.value.message, message_id: messageEdit.value.id, user_id: userLogin.value.id, action_type: action_type, messages_type: 'group' }
                    socket.value.emit('message_update', data)
                    messageEdit.value = null
                }
                if (navi.value === 'toato') {
                    data = { message: messageEdit.value.message, message_id: messageEdit.value.id, user_id: psychologyMessageToaTo.value.id, action_type: action_type, messages_type: 'toato' }
                    socket.value.emit('message_update', data)
                    messageEdit.value = null
                }

                if (navi.value === 'psi') {
                    data = { message: messageEdit.value.message, message_id: messageEdit.value.id, user_id: psychologyMessage.value.id, action_type: action_type, messages_type: 'psi', rol: psychologyMessage.value.rol }
                    socket.value.emit('message_update', data)
                    messageEdit.value = null
                }

            }

            ///////////////////states/////////////////////////
            const fileInput = ref(null); // Referencia al input de archivos
            const selectedImage = ref(null); // Almacena la imagen seleccionada
            const fileImg = ref(null)
            const titleState = ref(null)
            const statesToaTo = ref(null)
            const showStates = ref(null)
            const carrusel = ref(null)
            const progress = ref(0);



            const animateProgress = (duration, updateCallback) => {
                return new Promise((resolve) => {
                    let start = null;
                    const animate = (timestamp) => {
                        if (!start) start = timestamp;
                        const elapsed = timestamp - start;
                        let progressValue = Math.min((elapsed / duration) * 100, 100); // Calcula el progreso entre 0 y 100

                        updateCallback(progressValue); // Llamamos al callback para actualizar el valor de progreso

                        if (elapsed < duration) {
                            requestAnimationFrame(animate); // Continuamos la animación
                        } else {
                            resolve(); // Finalizamos cuando el progreso llega a 100
                        }
                    };
                    requestAnimationFrame(animate);
                });
            };

            const haddleGetStates = async () => {
                try {
                    const response = await axios.get(`/states/all`);
                    if (response.status == 200) {
                        statesToaTo.value = response.data
                    }
                    if (response.status == 404) {
                        statesToaTo.value = null
                    }
                } catch (error) {
                    console.log(error)
                }
            }

            let cancelToken = null;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));


            const handleShowStates = async (data) => {
                const currentToken = Symbol();
                cancelToken = currentToken;

                showStates.value = data;

                for (const element of showStates.value[1]) {
                    if (cancelToken !== currentToken) {
                        break;
                    }
                    carrusel.value = element;
                    await animateProgress(3000, (progressValue) => {
                        progress.value = progressValue; // Actualizamos el progreso en la interfaz
                    });
                }
                if (cancelToken === currentToken) {
                    carrusel.value = null;
                    showStates.value = null;
                }
            };



            onMounted(() => {
                haddleGetStates();
                socket.value.on('update_states', (data) => {
                    haddleGetStates();
                });

            });



            const selectImage = () => {
                fileInput.value.click();
            };

            const onFileSelected = (event) => {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    // Crear un URL para la imagen seleccionada
                    fileImg.value = file
                    selectedImage.value = URL.createObjectURL(file);
                } else {
                    alert('Por favor, selecciona una imagen válida.');
                }
            };

            const closeModalStateCreate = () => selectedImage.value = null

            const sendState = async () => {
                try {
                    const formData = new FormData();
                    formData.append("image", fileImg.value);
                    formData.append("title", titleState.value);


                    const response = await axios.post('/states/save', formData);
                    if (response.status == 200) {
                        selectedImage.value = null
                        titleState.value = null
                        haddleGetStates()
                    }
                } catch (error) {
                    console.error('Error al subir la imagen', error);
                }
            }

            const componet_states = {
                fileInput,
                titleState,
                selectedImage,
                selectImage,
                onFileSelected,
                closeModalStateCreate,
                sendState,
                statesToaTo,
                handleShowStates,
                showStates,
                carrusel,
                progress
            }





            return {
                userLogin,

                messages,
                message,
                sendMessage,



                emojis,
                toogleEmojis,
                modalEmojis,
                adEmoji,


                navi,
                toogleNvigate,

                psych,

                psychologyMessage,
                toogleNaviChatPsyc,

                countMessages,

                sidebarPsych,
                toogleSidebarPsi,

                idUserAdminForm,
                userDataSearch,
                submitSaveRolUser,
                selectedRole,
                allUserAdminPsi,
                submitUserSelect,


                toogleSidebarToato,
                sidebarToaTo,
                toogleNaviChatToato,
                toogleNaviChatToatoFind,
                toato,
                psychologyMessageToaTo,

                userToato,


                modalUser,
                toogleModalUser,

                modalEditUser,
                toogleModalEditUser,


                deleteConexion,

                toogleModalEditMessage,
                messageEdit,
                saveMessage,


                ...componet_states

            };
        }
    }).mount('#app');
</script>




<style>
    .scrollbar-custom::-webkit-scrollbar {
        width: 8px;
        /* Ancho del scrollbar */
        height: 8px;
        /* Altura del scrollbar (para el desplazamiento horizontal) */
    }

    .scrollbar-custom::-webkit-scrollbar-thumb {
        background-color: #888;
        /* Color del "pulgar" */
        border-radius: 10px;
        /* Bordes redondeados */
    }

    .scrollbar-custom::-webkit-scrollbar-thumb:hover {
        background-color: #555;
        /* Color del "pulgar" al pasar el ratón por encima */
    }
</style>
{% endblock %}